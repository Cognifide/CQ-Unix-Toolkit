#!/bin/sh
# CQ Unix Toolkit
# Copyright (C) 2013 Cognifide Limited
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
INSTALL_DIR="/usr/local/bin"
if [ "${USER}" != 'root' ]
then
    echo "Please execute with superuser privileges" >&2
    exit 1
fi

ECHO=$(which echo)
if [ ${?} -ne 0 ]
then
    ECHO="echo"
else
    ECHO="${ECHO} -e "
fi
dir=$(dirname "${0}")
basedir=$(readlink -f "${dir}")
${ECHO} "I assume that CQ UNIX toolkit are in: '${basedir}'\n"
if [ ! -d "${INSTALL_DIR}" ] 
then
    echo "Cannot find '${INSTALL_DIR}' directory" >&2
    exit 1
fi

existing_tools=""
warning=0
count=0
total=0
cmds=""
for cmd in cq*
do
    total=$((total+1))
    if [ -f "${INSTALL_DIR}/${cmd}" ]
    then
        if [ -L "${INSTALL_DIR}/${cmd}" ]
        then
            target=$(readlink -f "${INSTALL_DIR}/${cmd}")
            output="${INSTALL_DIR}/${cmd} --> ${target} (symbolic link)\n"
        else
            output="${INSTALL_DIR}/${cmd} (binary file)\n"
        fi
        count=$((count+1))
        existing_tools="${existing_tools}${output}"
        warning=1
    fi
    cmds="${cmds} ${cmd}"
done
if [ ! -z "${existing_tools}" ]
then
    ${ECHO} "${count} currently existing commands will be overwritten:"
    ${ECHO} "${existing_tools}"
fi

options=""
${ECHO} \
    "${total} commands (symbolic links) will be installed in: ${INSTALL_DIR}\n"
if [ ${warning} -eq 1 ]
then
    ${ECHO} "Would you like to:"
    ${ECHO} "-- replace (a)ll ${count} links and install new files,"
    ${ECHO} "-- replace (i)ndividual ones, install new files"
    ${ECHO} "-- (s)kip existing ones, install new files"
    ${ECHO} "-- (q)uit\n"
    read -p "   (a/i/s/q) ? " REPLY
    if [ "${REPLY}" != "A" -a "${REPLY}" != "a" -a "${REPLY}" != "i" \
        -a "${REPLY}" != "I" -a "${REPLY}" != "s" -a "${REPLY}" != "S" ]
    then
        echo "Aborted"
        exit 1
    fi
    ask=0
    options=""
    force=0
    case "${REPLY}" in
        A) force=1; options="-f" ;;
        a) force=1; options="-f" ;;
        I) ask=1; options="-f";;
        i) ask=1; options="-f";;
    esac
else
    read -p "Do you want to continue (Y/N) ? " REPLY
    if [ "${REPLY}" != "Y" -a "${REPLY}" != "y" ]
    then
        echo "Aborted"
        exit 1
    fi
fi

for cmd in ${cmds}
do
    confirmed=1
    if [ ${ask} -eq 1 ]
    then
        read -p "Would you like to replace '${INSTALL_DIR}/${cmd}' (Y/N) ? "\
        REPLY
        if [ "${REPLY}" != "Y" -a "${REPLY}" != "y" ]
        then
            confirmed=0
        fi
    fi
    if [ ${confirmed} -eq 1 ]
    then
        if [ ${force} -eq 1 -o ! -f "${INSTALL_DIR}/${cmd}" ]
        then
            ln ${options} -s "${basedir}/${cmd}" "${INSTALL_DIR}/${cmd}"
        fi
    fi
done
${ECHO} "\nInstallation finished."

